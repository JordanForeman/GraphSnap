{{#if test}}
<h1>{{test.name}}</h1>
<h3>
{{#if test.isQuantitative}}
<script type="text/javascript">var isQuantitative = true; </script>
Quantitative
{{/if}}
{{#if test.isQualitative}}
<script type="text/javascript">var isQuantitative = false; </script>
Qualitative
{{/if}}
</h3>
{{/if}}

<div id="chart">
</div>

<script type="text/javascript">
nv.addGraph(function() {

	$.ajax({
		type: 'GET',
		url: '/api/TestValues/{{test._id}}',
		data: {
			token: "{{user.apiKey}}"
		},
		contentType: 'application/json',
		dataType: 'json',
		success: function(data){
			console.log("===========DATA==========");
			console.log(data);

			dataLoadedEventHandler(data);
		},
		error: dataLoadedErrorHandler,
		complete: function(jqxhr, textStatus){ return console.log(textStatus);}
	});

	var dataLoadedErrorHandler = function() {
		console.log("ERROR");
	};

	var dataLoadedEventHandler = function(data) {
		//TODO: make graph from data
		if (isQuantitative)
			buildQuantitativeChart(data);
		else
			buildQualitativeChart(data);
	};

	var buildQualitativeChart = function(data) {
		console.log("==== Qualitative Chart ====")

		var color = d3.scale.ordinal()
			.range(["red", "blue", "orange"]);

		var chartData = cleanQualData(data),
			radius = 300;

		console.log(chartData);

		var canvas = d3.select("#chart").append("svg")
			.attr("width", 1500)
			.attr("height", 1500);

		var group = canvas.append("g")
			.attr("transform", "translate(300, 300)");

		var arc = d3.svg.arc()
			.innerRadius(radius - 100)
			.outerRadius(radius);

		var pie = d3.layout.pie()
			.value(function(d) { return d; });

		var arcs = group.selectAll(".arc")
			.data(pie(chartData))
			.enter()
			.append("g")
			.attr("class", "arc");

		arcs.append("path")
			.attr("d", arc)
			.attr("fill", function (d) { return color(d.data); });


	};

	var buildQuantitativeChart = function(data) {
		console.log("==== Quantitative Chart ====")

		var chartData = cleanQuantData(data),
			w = 700,
			h = 300,
			max = d3.max(chartData);

		// Scales
		var x = d3.scale.linear().domain([0, data.length - 1]).range(0, w),
			y = d3.scale.linear().domain([0, max]).range(0, h);

		// Base vis layer
		var vis = d3.select('#chart')
					.append('svg:svg')
					.attr('width', w)
					.attr('height', h);

		// Add Path Layer
		vis.selectAll('path.line')
			.data(chartData)
			.enter().append("svg:path")
			.attr("d", d3.svg.line()
				.x(function(d, i){
					return x(i);
				}).y(y));

	};

	var cleanQuantData = function(data) {

		var returnData = new Array();

		for (var i = 0; i < data.length; i++) {
			var datapoint = data[i];
			returnData.push(datapoint.quantValue);
		}

		return returnData;

	};

	var cleanQualData = function(data) {

		var yeps = 0,
			nopes = 0;

		for (var i = 0; i < data.length; i++) {
			var datapoint = data[i];

			if (datapoint.qualValue)
				yeps++
			else
				nopes++
		}

		return [yeps, nopes];

	};

});	
</script>
